# Fagan-Style Inspection (2026-02-10): terraform-provider-discord (45ck fork)

## Objective

Improve correctness, maintainability, and "no clickops" coverage by aligning the provider on a single Discord REST API layer and applying Terraform provider best practices.

This inspection was performed from two viewpoints and then reconciled:

* Terraform provider engineering viewpoint: schema, state, drift, import, plan/apply behavior, UX.
* Discord API engineering viewpoint: endpoint semantics, rate limits, permissions, data model stability.

## Scope

* In-scope: all provider resources/data sources; special focus on remaining `disgord`-based implementations and mixed REST vs `disgord` behavior.
* Out-of-scope: migration to `terraform-plugin-framework` (not started; only recommendations captured).

## Entry Criteria

* REST client layer exists (`discord/rest_client.go`, `discord/rest_client_multipart.go`) and is already used by many resources.
* Escape hatches exist for "no reasonable limits":
  * `discord_api_resource` (generic CRUD)
  * `discord_api_request` (generic GET)
  * `discord_guild_settings` (arbitrary guild PATCH)

## Inspection Checklist

Terraform checklist:

* Every resource: CRUD idempotency, drift detection, import behavior, delete semantics, and stable IDs.
* Schema correctness: `ForceNew` vs `Update`, computed vs optional, diff suppressions, and validation.
* State safety: do not store unstable/ephemeral fields; normalize JSON; ensure read refreshes computed fields.
* Error handling: consistent 404 -> remove from state; useful diagnostics.
* Timeouts and retries: rate limits, eventual consistency, and bounded retries.

Discord checklist:

* Endpoint correctness: request/response shapes, required fields, and type conversions (notably permission bitfields).
* Rate limits: 429 retry behavior, global limits, and not leaking response bodies.
* Auditing: `X-Audit-Log-Reason` support on applicable endpoints.
* Scalability: avoid "list everything" endpoints for lookups when guilds are large or intents/permissions are required.
* Data model stability: be cautious with username-based lookups and fields that Discord has evolved over time.

## Defect Log (Prioritized)

### Critical

1. Mixed API layers (`disgord` + REST) yields inconsistent behavior and a long-term maintenance trap.
   * Files: `discord/config.go`, plus multiple `resource_discord_*.go` and `data_source_discord_*.go` files still importing `disgord`.
   * Symptoms:
     * Different retry/error behavior depending on which resource is used.
     * Inconsistent handling of 404 (some resources clear state, some just error).
     * Auditing reason header only exists in the REST client.
   * Recommended fix:
     * Migrate remaining `disgord` resources/data sources to REST.
     * Remove `Client *disgord.Client` from the provider context once migration completes.

2. Member lookup by `username` + `discriminator` is not scalable and is increasingly unreliable.
   * File: `discord/data_source_discord_member.go`
   * Problem:
     * Uses full member listing (`GetMembers` with `Limit: 0`) to find a member by name. This is O(n) and will fail or be extremely slow for large guilds.
     * Discord identity model has evolved; name-based lookups are not stable identifiers.
   * Recommended fix:
     * Prefer `user_id` only.
     * If name search is retained, use Discord's search endpoint (if available/allowed) and document limitations.

3. `discord_server` data source lookup by `name` is generally incompatible with bot-only tokens.
   * File: `discord/data_source_discord_server.go`
   * Problem:
     * Uses a "current user guilds" listing style API which is typically a user-token concept; bots cannot reliably enumerate guilds.
   * Recommended fix:
     * Deprecate `name` and strongly prefer `server_id`.

### High

4. Inconsistent and incomplete 64-bit permission bit handling across the provider.
   * Files: role/overwrite resources had 64-bit support added, but documentation and some schemas still assume `TypeInt`.
   * Recommended fix:
     * Prefer 64-bit string fields (`*_bits64`) across resources and docs.
     * Keep `TypeInt` fields only for backwards compatibility.

5. Redundant/legacy channel resources increase surface area and divergence.
   * Files: `discord/resource_discord_{text,voice,category}_channel.go`, `discord/resource_discord_channel.go`, `discord/resource_discord_channel_rest.go`
   * Problem:
     * Multiple resources manage "channels" with different schemas/behavior.
   * Recommended fix:
     * Keep the legacy resources for compatibility but implement them as wrappers over the REST `discord_channel` behavior so the API layer is unified.
     * Document `discord_channel` as the preferred interface.

6. Message and embed handling is still `disgord`-centric.
   * Files: `discord/resource_discord_message.go`, `discord/util_embed.go`, and `discord/resource_discord_thread.go` embed paths.
   * Recommended fix:
     * Implement message CRUD via REST.
     * Represent embeds as plain JSON maps or provider-local structs (remove `disgord` types).

7. Mixed `context` imports and older patterns.
   * Files: several resources import `golang.org/x/net/context` while others use stdlib `context`.
   * Recommended fix:
     * Standardize on stdlib `context` everywhere.

### Medium

8. Rate limit handling should consider Discord "global" rate limits explicitly.
   * File: `discord/rest_client.go`
   * Current behavior:
     * Retries 429 using body `retry_after` or headers.
     * Does not coordinate global limits across concurrent requests.
   * Recommended fix:
     * If 429 indicates `global: true`, gate subsequent requests behind a shared global limiter/mutex until the cooldown elapses.

9. Several "delete" operations are best-effort/no-op but are not consistently documented.
   * Example: ordering resources (`discord_channel_order`, `discord_role_order`) are intentionally non-reverting.
   * Recommended fix:
     * Ensure all non-reverting deletes emit consistent warnings and are documented.

### Low

10. Provider identification: `User-Agent` is static and does not include version/build info.
    * File: `discord/rest_client.go`
    * Recommended fix:
      * Include provider version when available (build-time variable), while keeping it stable for caching/logging.

## Consultation: Terraform vs Discord Perspective (Reconciled)

Terraform perspective:

* First-class resources are valuable for stable state, imports, and drift detection.
* Escape hatches (`discord_api_resource`, `discord_api_request`, `discord_guild_settings`) are still required to avoid provider lag behind Discord API changes.
* Deprecated legacy resources should remain for backwards compatibility but must share the same transport/error model.

Discord perspective:

* IDs are the only stable identifiers; name-based lookups should be best-effort or deprecated.
* Avoid endpoints that require enumerating large sets (members, guild lists) unless the API guarantees it for bots.
* Permission bitfields are 64-bit and must be treated as such end-to-end.

Combined recommendation:

* Keep first-class resources for core admin workflows, but ensure "no reasonable limits" by:
  * Maintaining the escape hatches.
  * Keeping the REST layer as the single underlying transport.

## Action Plan (Recommended)

1. Phase 1 (short, low risk)
   * Fix correctness bugs in data sources (role position semantics, bot-safe behavior).
   * Update docs for 64-bit permission fields across resources.
   * Remove remaining `disgord` usage from REST-based resources (example: role order reads, embed maps).

2. Phase 2 (medium)
   * Migrate `discord_message`, `discord_role`, `discord_role_everyone`, `discord_system_channel`, and legacy channel resources to REST implementations.
   * Preserve schemas and IDs to avoid breaking state; use `StateUpgraders` only if necessary.

3. Phase 3 (large)
   * Remove `disgord` from the provider context and `go.mod` once no resource depends on it.
   * Standardize on stdlib `context` and common error handling patterns.

4. Phase 4 (optional, strategic)
   * Evaluate a gradual migration to `terraform-plugin-framework` for better typing, plan modifiers, and improved UX.
   * Consider generating REST request/response types from Discord's OpenAPI spec to reduce drift.

## Post-Inspection Actions (Implemented)

After this inspection, the fork was updated to fully remove the `disgord` dependency and unify on the internal REST client layer:

* Migrated remaining `disgord`-based resources/data sources (roles, messages, member roles, invites, legacy channel resources, server and system channel, and the member/role/server data sources).
* Removed `disgord` from `go.mod` and provider runtime context.
* Standardized on stdlib `context` and provider-local structs for embeds and permission overwrites.
